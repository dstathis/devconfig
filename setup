#!/bin/bash

function printhelp {
    echo USAGE: setup [k] [--headless]
}

# READ ARGS
while [ ! -z  ${1} ]; do
    case ${1} in
        '--headless')
            headless='yes'
            ;;
        'k')
            skipemail='yes'
            ;;
        *)
            printhelp
            exit 1
    esac
    shift
done

if [ -z ${headless} ]; then
    pkgpattern='s/!//g'
else
    pkgpattern='s/!/#/g'
fi

if [ -z ${skipemail} ]; then
    read -p "Email for git: " gitemail
fi

. /etc/os-release

if [ ${ID_LIKE} == "debian" ]; then
    os=debian
elif [ ${ID} == "fedora" ]; then
    os=fedora
else
    echo "ERROR: Unknown OS" 1>&2
fi

pkgs=$(cat pkgs-common pkgs-${os} | sed ${pkgpattern} | sed '/#.*\|^$/d')

if [ ${os} == "fedora" ]; then
    rpm -q ${pkgs} > /dev/null
    if [ $? -ne 0 ]; then
            sudo dnf install -y ${pkgs}
    fi
fi

if [ ${os} == debian ]; then
    dpkg -V ${pkgs} 1>/dev/null 2>/dev/null
    if [ $? -ne 0 ]; then
        sudo apt install -y -o Dpkg::Options::=--force-confdef -o Dpkg::Options::=--force-confnew ${pkgs}
    fi
fi

mkdir -p ~/.config/i3 ~/bin
cp ./i3 ~/.config/i3/config
if [ -f ~/.config/i3/local-config ]; then
    cat ~/.config/i3/local-config >> ~/.config/i3/config
fi
cp i3status.conf ~/.i3status.conf
cp setvol ~/bin/

dconf load /com/gexperts/Tilix/ < tilix.dconf

cp aliases ~/.aliases

cp gitconfig ~/.gitconfig
if [ ! -z ${gitemail} ]; then
    sed -i "s/email = .*/email = ${gitemail}/g" ~/.gitconfig
fi

grep -q "\.aliases" ~/.bashrc
if [ $? -ne 0 ]; then
    echo '. ~/.aliases' >> ~/.bashrc
fi
grep -q 'ssh-add' ~/.bashrc
if [ $? -ne 0 ]; then
    echo "sshkeys=\$(\\ls ~/.ssh/id_* | grep -v '\\.pub')" >> ~/.bashrc
    echo 'ssh-add ${sshkeys} 2> /dev/null' >> ~/.bashrc
fi

# Setup vim
if [ ! -f ~/.vim/autoload/plug.vim ]; then
    curl -fLo ~/.vim/autoload/plug.vim --create-dirs https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
fi
mkdir -p ${HOME}/.vim/ftplugin
mkdir -p ${HOME}/.vim/indent
cp vimrc ${HOME}/.vimrc
mkdir -p ${HOME}/.vim/ftplugin
cp vimrc-python ${HOME}/.vim/ftplugin/python.vim
cp indent/* ${HOME}/.vim/indent/
mkdir -p ${HOME}/.vim/plugins
